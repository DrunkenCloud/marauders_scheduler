generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id        Int       @id @default(autoincrement())
  name      String    @unique       // e.g., "Spring 2025", "Fall 2025"
  details   String?                   // optional description
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  students       Student[]
  studentGroups  StudentGroup[]
  faculties      Faculty[]
  facultyGroups  FacultyGroup[]
  halls          Hall[]
  hallGroups     HallGroup[]
  courses        Course[]
}

model Student {
  id            Int       @id @default(autoincrement())
  digitalId     Int       @unique
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(15)  // working day end hour (0-23)
  endMinute     Int       @default(30)  // working day end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentGroupMemberships  StudentGroupMembership[]
  courseEnrollments        CourseStudentEnrollment[]
}

model StudentGroup {
  id            Int       @id @default(autoincrement())
  groupName     String    @unique
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(15)  // working day end hour (0-23)
  endMinute     Int       @default(30)  // working day end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                    Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentMemberships         StudentGroupMembership[]
  courseGroupEnrollments     CourseStudentGroupEnrollment[]
}

model StudentGroupMembership {
  id             Int          @id @default(autoincrement())
  studentId      Int
  studentGroupId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentGroup   StudentGroup @relation(fields: [studentGroupId], references: [id], onDelete: Cascade)

  @@unique([studentId, studentGroupId])
}

model Faculty {
  id            Int       @id @default(autoincrement())
  name          String
  shortForm     String?
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(17)  // working day end hour (0-23) - faculty can work later
  endMinute     Int       @default(0)   // working day end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  facultyGroupMemberships  FacultyGroupMembership[]
  coursesTaught            Course[] @relation("CompulsoryFaculty")
}

model FacultyGroup {
  id            Int       @id @default(autoincrement())
  groupName     String    @unique
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(17)  // working day end hour (0-23) - faculty can work later
  endMinute     Int       @default(0)   // working day end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  facultyMemberships     FacultyGroupMembership[]
  compulsoryCourses      CompulsoryFacultyGroup[]
}

model FacultyGroupMembership {
  id             Int          @id @default(autoincrement())
  facultyId      Int
  facultyGroupId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  faculty        Faculty      @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  facultyGroup   FacultyGroup @relation(fields: [facultyGroupId], references: [id], onDelete: Cascade)

  @@unique([facultyId, facultyGroupId])
}

model Hall {
  id            Int       @id @default(autoincrement())
  name          String
  Floor         String
  Building      String
  shortForm     String?
  timetable     Json
  startHour     Int       @default(8)   // availability start hour (0-23)
  startMinute   Int       @default(10)  // availability start minute (0-59)
  endHour       Int       @default(20)  // availability end hour (0-23) - halls can be used later
  endMinute     Int       @default(0)   // availability end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hallGroupMemberships   HallGroupMembership[]
  coursesTaught          Course[] @relation("CompulsoryHalls")
}

model HallGroup {
  id            Int       @id @default(autoincrement())
  groupName     String    @unique
  timetable     Json
  startHour     Int       @default(8)   // availability start hour (0-23)
  startMinute   Int       @default(10)  // availability start minute (0-59)
  endHour       Int       @default(20)  // availability end hour (0-23) - halls can be used later
  endMinute     Int       @default(0)   // availability end minute (0-59)
  sessionId     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session               Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hallMemberships       HallGroupMembership[]
  compulsoryCourses     CompulsoryHallGroup[]
}

model HallGroupMembership {
  id          Int       @id @default(autoincrement())
  hallId      Int
  hallGroupId Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  hall        Hall      @relation(fields: [hallId], references: [id], onDelete: Cascade)
  hallGroup   HallGroup @relation(fields: [hallGroupId], references: [id], onDelete: Cascade)

  @@unique([hallId, hallGroupId])
}

model Course {
  id                      Int                   @id @default(autoincrement())
  name                    String
  code                    String                @unique
  timetable               Json
  classDuration           Int                   @default(50)        // minutes per session
  sessionsPerLecture      Int                   @default(1)         // consecutive sessions needed
  totalSessions           Int                   @default(3)         // total sessions per week
  scheduledCount          Int                   @default(0)         // number of lectures already scheduled
  sessionId               Int
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  compulsoryFaculties      Faculty[] @relation("CompulsoryFaculty")
  compulsoryHalls          Hall[] @relation("CompulsoryHalls")
  compulsoryFacultyGroups  CompulsoryFacultyGroup[]
  compulsoryHallGroups     CompulsoryHallGroup[]
  studentEnrollments       CourseStudentEnrollment[]
  studentGroupEnrollments  CourseStudentGroupEnrollment[]
}

model CompulsoryFacultyGroup {
  id             Int          @id @default(autoincrement())
  courseId       Int
  facultyGroupId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  facultyGroup   FacultyGroup @relation(fields: [facultyGroupId], references: [id], onDelete: Cascade)

  @@unique([courseId, facultyGroupId])
}

model CompulsoryHallGroup {
  id            Int       @id @default(autoincrement())
  courseId      Int
  hallGroupId   Int
  requiredCount Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  hallGroup     HallGroup @relation(fields: [hallGroupId], references: [id], onDelete: Cascade)

  @@unique([courseId, hallGroupId])
}

model CourseStudentEnrollment {
  id        Int      @id @default(autoincrement())
  courseId  Int
  studentId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
}

model CourseStudentGroupEnrollment {
  id             Int          @id @default(autoincrement())
  courseId       Int
  studentGroupId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentGroup   StudentGroup @relation(fields: [studentGroupId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentGroupId])
}

// Example timetable JSON
// {
//    "Monday": [
//       ["09:00", "10:00", "CS101", "LAB"],
//       ["14:00", "15:00", "MATH202"]
//    ],
//    "Tuesday": [
//       ["10:30", "11:30", "CHEM301"],
//       ["13:00", "14:00", "PHYS201"]
//    ],
//    "Wednesday": [
//       ["09:00", "10:00", "CS101"],
//       ["14:00", "15:00", "MATH202"]
//    ],
//    "Thursday": [],
//    "Friday": [
//       ["09:00", "10:00", "CS101"]
//    ]
// }
