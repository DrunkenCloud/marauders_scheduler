generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id        String    @id @default(uuid())
  name      String    @unique       // e.g., "Spring 2025", "Fall 2025"
  details   String?                   // optional description
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  students       Student[]
  studentGroups  StudentGroup[]
  faculties      Faculty[]
  facultyGroups  FacultyGroup[]
  halls          Hall[]
  hallGroups     HallGroup[]
  courses        Course[]
}

model Student {
  id            String    @id @default(uuid())
  digitalId     Int
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(15)  // working day end hour (0-23)
  endMinute     Int       @default(30)  // working day end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentGroupMemberships  StudentGroupMembership[]
  courseEnrollments        CourseStudentEnrollment[]
}

model StudentGroup {
  id            String    @id @default(uuid())
  groupName     String
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(15)  // working day end hour (0-23)
  endMinute     Int       @default(30)  // working day end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                    Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentMemberships         StudentGroupMembership[]
  courseGroupEnrollments     CourseStudentGroupEnrollment[]
}

model StudentGroupMembership {
  id             String       @id @default(uuid())
  studentId      String
  studentGroupId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentGroup   StudentGroup @relation(fields: [studentGroupId], references: [id], onDelete: Cascade)
}

model Faculty {
  id            String    @id @default(uuid())
  name          String
  shortForm     String?
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(17)  // working day end hour (0-23) - faculty can work later
  endMinute     Int       @default(0)   // working day end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  facultyGroupMemberships  FacultyGroupMembership[]
  coursesTaught            Course[] @relation("CompulsoryFaculty")
}

model FacultyGroup {
  id            String    @id @default(uuid())
  groupName     String
  timetable     Json
  startHour     Int       @default(8)   // working day start hour (0-23)
  startMinute   Int       @default(10)  // working day start minute (0-59)
  endHour       Int       @default(17)  // working day end hour (0-23) - faculty can work later
  endMinute     Int       @default(0)   // working day end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  facultyMemberships     FacultyGroupMembership[]
  compulsoryCourses      CompulsoryFacultyGroup[]
}

model FacultyGroupMembership {
  id             String       @id @default(uuid())
  facultyId      String
  facultyGroupId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  faculty        Faculty      @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  facultyGroup   FacultyGroup @relation(fields: [facultyGroupId], references: [id], onDelete: Cascade)
}

model Hall {
  id            String    @id @default(uuid())
  name          String
  Floor         String
  Building      String
  shortForm     String?
  timetable     Json
  startHour     Int       @default(8)   // availability start hour (0-23)
  startMinute   Int       @default(10)  // availability start minute (0-59)
  endHour       Int       @default(20)  // availability end hour (0-23) - halls can be used later
  endMinute     Int       @default(0)   // availability end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session                Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hallGroupMemberships   HallGroupMembership[]
  coursesTaught          Course[] @relation("CompulsoryHalls")
}

model HallGroup {
  id            String    @id @default(uuid())
  groupName     String
  timetable     Json
  startHour     Int       @default(8)   // availability start hour (0-23)
  startMinute   Int       @default(10)  // availability start minute (0-59)
  endHour       Int       @default(20)  // availability end hour (0-23) - halls can be used later
  endMinute     Int       @default(0)   // availability end minute (0-59)
  sessionId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session               Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hallMemberships       HallGroupMembership[]
  compulsoryCourses     CompulsoryHallGroup[]
}

model HallGroupMembership {
  id          String    @id @default(uuid())
  hallId      String
  hallGroupId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  hall        Hall      @relation(fields: [hallId], references: [id], onDelete: Cascade)
  hallGroup   HallGroup @relation(fields: [hallGroupId], references: [id], onDelete: Cascade)
}

model Course {
  id                      String                @id @default(uuid())
  name                    String
  code                    String
  timetable               Json
  classDuration           Int                   @default(50)        // minutes per session
  sessionsPerLecture      Int                   @default(1)         // consecutive sessions needed
  totalSessions           Int                   @default(3)         // total sessions per week
  scheduledCount          Int                   @default(0)         // number of lectures already scheduled
  sessionId               String
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt

  session                  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  compulsoryFaculties      Faculty[] @relation("CompulsoryFaculty")
  compulsoryHalls          Hall[] @relation("CompulsoryHalls")
  compulsoryFacultyGroups  CompulsoryFacultyGroup[]
  compulsoryHallGroups     CompulsoryHallGroup[]
  studentEnrollments       CourseStudentEnrollment[]
  studentGroupEnrollments  CourseStudentGroupEnrollment[]
}

model CompulsoryFacultyGroup {
  id             String       @id @default(uuid())
  courseId       String
  facultyGroupId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  facultyGroup   FacultyGroup @relation(fields: [facultyGroupId], references: [id], onDelete: Cascade)
}

model CompulsoryHallGroup {
  id            String    @id @default(uuid())
  courseId      String
  hallGroupId   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  hallGroup     HallGroup @relation(fields: [hallGroupId], references: [id], onDelete: Cascade)
}

model CourseStudentEnrollment {
  id        String   @id @default(uuid())
  courseId  String
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model CourseStudentGroupEnrollment {
  id             String       @id @default(uuid())
  courseId       String
  studentGroupId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  course         Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentGroup   StudentGroup @relation(fields: [studentGroupId], references: [id], onDelete: Cascade)
}

// Example timetable JSON (TimetableSlot format)
// {
//    "Monday": [
//       {
//         "type": "course",
//         "startHour": 9,
//         "startMinute": 0,
//         "duration": 50,
//         "courseId": 1,
//         "courseCode": "CS101",
//         "hallIds": [1],
//         "facultyIds": [1],
//         "studentIds": [1, 2, 3],
//         "hallGroupIds": [],
//         "facultyGroupIds": [],
//         "studentGroupIds": []
//       },
//       {
//         "type": "blocker",
//         "startHour": 14,
//         "startMinute": 0,
//         "duration": 60,
//         "blockerReason": "Lunch Break"
//       }
//    ],
//    "Tuesday": [],
//    "Wednesday": [
//       {
//         "type": "course",
//         "startHour": 10,
//         "startMinute": 30,
//         "duration": 50,
//         "courseId": 2,
//         "courseCode": "MATH202"
//       }
//    ],
//    "Thursday": [],
//    "Friday": []
// }
